<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NoteScribe ‚Äî Audio to Sheet Music</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400&family=DM+Mono:wght@300;400;500&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
<style>
  :root {
    --ink: #0d0d0d;
    --paper: #f5f0e8;
    --cream: #ede8dc;
    --staff-line: #c8bfa8;
    --accent: #c9453a;
    --accent2: #2a5fa8;
    --gold: #c8922a;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--paper);
    color: var(--ink);
    font-family: 'DM Mono', monospace;
    min-height: 100vh;
    overflow-x: hidden;
    cursor: crosshair;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: repeating-linear-gradient(
      to bottom,
      transparent 0px, transparent 18px,
      var(--staff-line) 18px, var(--staff-line) 19px,
      transparent 19px, transparent 23px,
      var(--staff-line) 23px, var(--staff-line) 24px,
      transparent 24px, transparent 28px,
      var(--staff-line) 28px, var(--staff-line) 29px,
      transparent 29px, transparent 33px,
      var(--staff-line) 33px, var(--staff-line) 34px,
      transparent 34px, transparent 38px,
      var(--staff-line) 38px, var(--staff-line) 39px,
      transparent 39px, transparent 100px
    );
    opacity: 0.18;
    pointer-events: none;
    z-index: 0;
  }

  .container { position: relative; z-index: 1; max-width: 1000px; margin: 0 auto; padding: 0 32px; }

  header { padding: 48px 0 24px; border-bottom: 3px double var(--ink); margin-bottom: 60px; }
  .header-inner { display: flex; align-items: baseline; justify-content: space-between; flex-wrap: wrap; gap: 16px; }
  .logo { display: flex; align-items: baseline; gap: 12px; }
  .logo-symbol { font-family: 'Playfair Display', serif; font-size: 52px; font-weight: 900; color: var(--accent); line-height: 1; }
  .logo-text { font-family: 'Playfair Display', serif; font-size: 42px; font-weight: 700; letter-spacing: -1px; }
  .logo-text span { color: var(--accent2); }
  .tagline { font-family: 'Instrument Serif', serif; font-style: italic; font-size: 15px; color: #666; }

  .hero { text-align: center; margin-bottom: 64px; }
  .hero h2 { font-family: 'Playfair Display', serif; font-size: clamp(28px, 5vw, 52px); font-weight: 400; line-height: 1.15; margin-bottom: 16px; }
  .hero h2 em { font-style: italic; color: var(--accent); }
  .hero p { font-size: 13px; color: #555; letter-spacing: 0.5px; max-width: 520px; margin: 0 auto; line-height: 1.7; }

  .section-label { font-size: 10px; letter-spacing: 3px; text-transform: uppercase; color: var(--accent); margin-bottom: 16px; display: flex; align-items: center; gap: 12px; }
  .section-label::after { content: ''; flex: 1; height: 1px; background: var(--staff-line); }

  .upload-zone { border: 2px dashed var(--ink); background: rgba(255,255,255,0.5); border-radius: 2px; padding: 56px 32px; text-align: center; cursor: pointer; transition: all 0.2s ease; position: relative; overflow: hidden; }
  .upload-zone::before { content: ''; position: absolute; inset: 6px; border: 1px solid var(--staff-line); pointer-events: none; }
  .upload-zone:hover, .upload-zone.drag-over { border-color: var(--accent); background: rgba(201,69,58,0.04); transform: translateY(-2px); box-shadow: 6px 6px 0 var(--ink); }
  .upload-icon { font-size: 48px; margin-bottom: 16px; display: block; }
  .upload-title { font-family: 'Playfair Display', serif; font-size: 22px; font-weight: 700; margin-bottom: 8px; }
  .upload-sub { font-size: 11px; color: #777; letter-spacing: 1px; }
  .upload-formats { margin-top: 20px; display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; }
  .format-badge { font-size: 9px; letter-spacing: 2px; text-transform: uppercase; padding: 4px 10px; border: 1px solid var(--ink); background: var(--paper); font-weight: 500; }
  #file-input { display: none; }

  .file-preview { display: none; background: var(--cream); border: 1px solid var(--ink); padding: 20px 24px; margin-top: 16px; align-items: center; gap: 16px; }
  .file-preview.show { display: flex; }
  .file-icon { width: 44px; height: 52px; border: 2px solid var(--ink); background: white; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; position: relative; }
  .file-icon::after { content: ''; position: absolute; top: 0; right: 0; border: 8px solid transparent; border-top-color: var(--ink); border-right-color: var(--ink); }
  .file-info { flex: 1; }
  .file-name { font-size: 13px; font-weight: 500; margin-bottom: 3px; }
  .file-size { font-size: 11px; color: #888; }
  .remove-file { background: none; border: 1px solid var(--ink); width: 28px; height: 28px; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; transition: background 0.15s; }
  .remove-file:hover { background: var(--accent); color: white; border-color: var(--accent); }

  .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 48px; }
  @media(max-width:600px) { .options-grid { grid-template-columns: 1fr; } }
  .option-card { background: rgba(255,255,255,0.6); border: 1px solid var(--ink); padding: 24px; }
  .option-title { font-size: 10px; letter-spacing: 2px; text-transform: uppercase; color: #555; margin-bottom: 14px; font-weight: 500; }
  .radio-group { display: flex; flex-direction: column; gap: 10px; }
  .radio-option { display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 8px 12px; border: 1px solid transparent; transition: all 0.15s; }
  .radio-option:hover { border-color: var(--staff-line); background: rgba(255,255,255,0.8); }
  .radio-option.selected { border-color: var(--ink); background: white; }
  .radio-dot { width: 14px; height: 14px; border: 2px solid var(--ink); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
  .radio-dot::after { content: ''; width: 6px; height: 6px; background: var(--ink); border-radius: 50%; opacity: 0; transition: opacity 0.15s; }
  .radio-option.selected .radio-dot::after { opacity: 1; }
  .radio-label { font-size: 12px; }
  .radio-sub { font-size: 10px; color: #999; margin-top: 1px; }
  .styled-select { width: 100%; padding: 10px 14px; border: 1px solid var(--ink); background: white; font-family: 'DM Mono', monospace; font-size: 12px; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%230d0d0d'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 14px center; cursor: pointer; }

  /* Advanced toggles */
  .advanced-toggle { font-size: 11px; color: var(--accent2); cursor: pointer; letter-spacing: 1px; margin-bottom: 12px; display: inline-block; border-bottom: 1px dashed var(--accent2); }
  .advanced-panel { display: none; background: rgba(255,255,255,0.5); border: 1px solid var(--staff-line); padding: 20px; margin-bottom: 32px; }
  .advanced-panel.open { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .slider-label { font-size: 10px; letter-spacing: 1.5px; text-transform: uppercase; color: #666; margin-bottom: 8px; display: flex; justify-content: space-between; }
  input[type=range] { width: 100%; accent-color: var(--ink); cursor: pointer; }

  .transcribe-wrap { text-align: center; margin-bottom: 64px; }
  .btn-transcribe { font-family: 'Playfair Display', serif; font-size: 20px; font-weight: 700; letter-spacing: 1px; padding: 18px 56px; background: var(--ink); color: var(--paper); border: 2px solid var(--ink); cursor: pointer; transition: all 0.15s; position: relative; display: inline-block; }
  .btn-transcribe::after { content: ''; position: absolute; bottom: -6px; right: -6px; width: 100%; height: 100%; border: 2px solid var(--ink); z-index: -1; transition: all 0.15s; background: var(--accent); }
  .btn-transcribe:hover { transform: translate(-3px, -3px); }
  .btn-transcribe:hover::after { bottom: -9px; right: -9px; }
  .btn-transcribe:active { transform: translate(0,0); }
  .btn-transcribe:active::after { bottom: -3px; right: -3px; }
  .btn-transcribe:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

  /* Processing */
  .processing-section { display: none; margin-bottom: 48px; }
  .processing-section.show { display: block; }
  .pipeline { display: grid; grid-template-columns: repeat(4,1fr); border: 1px solid var(--ink); overflow: hidden; margin-bottom: 24px; }
  @media(max-width:600px) { .pipeline { grid-template-columns: 1fr 1fr; } }
  .pipeline-step { padding: 20px 16px; border-right: 1px solid var(--ink); text-align: center; background: rgba(255,255,255,0.4); transition: background 0.4s; }
  .pipeline-step:last-child { border-right: none; }
  .pipeline-step.active { background: var(--cream); }
  .pipeline-step.done { background: var(--ink); color: var(--paper); }
  .step-num { font-size: 9px; letter-spacing: 2px; text-transform: uppercase; color: #aaa; margin-bottom: 6px; }
  .pipeline-step.done .step-num { color: rgba(255,255,255,0.5); }
  .step-icon { font-size: 24px; margin-bottom: 6px; display: block; }
  .step-label { font-size: 10px; letter-spacing: 1px; text-transform: uppercase; font-weight: 500; }
  .progress-bar-wrap { height: 4px; background: var(--cream); border: 1px solid var(--staff-line); overflow: hidden; }
  .progress-bar { height: 100%; background: var(--ink); width: 0%; transition: width 0.5s ease; }
  .processing-message { text-align: center; font-size: 12px; color: #666; margin-top: 12px; font-style: italic; min-height: 20px; }

  /* Error */
  .error-box { background: #fff0ee; border: 1px solid var(--accent); padding: 20px 24px; margin-bottom: 24px; display: none; }
  .error-box.show { display: block; }
  .error-title { font-size: 12px; letter-spacing: 1px; text-transform: uppercase; color: var(--accent); margin-bottom: 8px; }
  .error-msg { font-size: 12px; line-height: 1.6; }

  /* Results */
  .results-section { display: none; margin-bottom: 64px; }
  .results-section.show { display: block; }
  .stats-row { display: grid; grid-template-columns: repeat(4,1fr); gap: 12px; margin-bottom: 24px; }
  @media(max-width:600px) { .stats-row { grid-template-columns: 1fr 1fr; } }
  .stat-card { background: white; border: 1px solid var(--ink); padding: 16px; text-align: center; }
  .stat-val { font-family: 'Playfair Display', serif; font-size: 28px; font-weight: 900; line-height: 1; margin-bottom: 4px; }
  .stat-label { font-size: 9px; letter-spacing: 2px; text-transform: uppercase; color: #888; }

  .notes-display { background: var(--cream); border: 1px solid var(--ink); padding: 24px; margin-bottom: 24px; }
  .notes-title { font-size: 10px; letter-spacing: 3px; text-transform: uppercase; margin-bottom: 16px; color: var(--accent); }
  .notes-scroll { display: flex; gap: 6px; flex-wrap: wrap; }
  .note-chip { font-family: 'Playfair Display', serif; font-size: 12px; font-weight: 700; padding: 4px 10px; border: 1px solid var(--ink); background: white; opacity: 0; transform: translateY(10px); animation: noteAppear 0.3s ease forwards; }
  @keyframes noteAppear { to { opacity: 1; transform: translateY(0); } }

  .sheet-music-display { background: white; border: 2px solid var(--ink); padding: 32px; margin-bottom: 24px; box-shadow: 8px 8px 0 var(--ink); overflow-x: auto; }
  .sheet-header { text-align: center; margin-bottom: 28px; border-bottom: 1px solid #ddd; padding-bottom: 20px; }
  .sheet-title { font-family: 'Playfair Display', serif; font-size: 24px; font-weight: 700; margin-bottom: 4px; }
  .sheet-subtitle { font-family: 'Instrument Serif', serif; font-style: italic; font-size: 14px; color: #777; }
  .sheet-meta { display: flex; justify-content: space-between; font-size: 11px; color: #999; margin-top: 8px; }

  .result-actions { display: flex; gap: 12px; flex-wrap: wrap; }
  .btn-action { font-family: 'DM Mono', monospace; font-size: 11px; letter-spacing: 1.5px; text-transform: uppercase; padding: 12px 24px; border: 1px solid var(--ink); background: white; cursor: pointer; transition: all 0.15s; display: flex; align-items: center; gap: 8px; text-decoration: none; color: var(--ink); }
  .btn-action:hover { background: var(--ink); color: white; }
  .btn-action.primary { background: var(--ink); color: white; }
  .btn-action.primary:hover { background: var(--accent); border-color: var(--accent); }

  footer { border-top: 3px double var(--ink); padding: 32px 0; display: flex; justify-content: space-between; align-items: center; font-size: 11px; color: #aaa; flex-wrap: wrap; gap: 8px; }
  .footer-brand { font-family: 'Playfair Display', serif; font-size: 16px; color: var(--ink); font-weight: 700; }

  .toast { position: fixed; bottom: 32px; right: 32px; background: var(--ink); color: var(--paper); padding: 14px 22px; font-size: 12px; z-index: 999; transform: translateY(100px); opacity: 0; transition: all 0.3s ease; border-left: 4px solid var(--accent); }
  .toast.show { transform: translateY(0); opacity: 1; }

  .waveform-display { height: 60px; background: white; border: 1px solid var(--staff-line); margin-bottom: 16px; display: flex; align-items: center; padding: 8px 16px; gap: 2px; overflow: hidden; }
  .wave-bar { flex: 1; background: var(--ink); border-radius: 1px; min-height: 2px; animation: waveAnim 1.5s ease-in-out infinite alternate; }
  @keyframes waveAnim { from { transform: scaleY(1); } to { transform: scaleY(0.2); } }

  /* Backend status */
  .backend-status { font-size: 10px; letter-spacing: 1px; display: flex; align-items: center; gap: 6px; }
  .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #ccc; }
  .status-dot.online { background: #2a9d2a; }
  .status-dot.offline { background: var(--accent); }
</style>
</head>
<body>

<div class="container">
  <header>
    <div class="header-inner">
      <div class="logo">
        <span class="logo-symbol">ùÑû</span>
        <span class="logo-text">Note<span>Scribe</span></span>
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
        <p class="tagline">Audio transcription to sheet music ‚Äî instantly</p>
        <div class="backend-status">
          <div class="status-dot" id="status-dot"></div>
          <span id="status-label">Checking backend‚Ä¶</span>
        </div>
      </div>
    </div>
  </header>

  <section class="hero">
    <h2>Turn any melody into<br><em>readable sheet music</em></h2>
    <p>Upload an audio file and NoteScribe will detect every note using Spotify's Basic Pitch model, build a MIDI representation, and render beautifully formatted sheet music.</p>
  </section>

  <!-- Upload Audio File Section - Input -->
  <section class="upload-section" style="margin-bottom:48px">
    <div class="section-label">01 ‚Äî Upload Audio</div>
    <div class="upload-zone" id="upload-zone">
      <span class="upload-icon">‚ô™</span>
      <div class="upload-title">Drop your audio file here</div>
      <p class="upload-sub">or click to browse your files</p>
      <div class="upload-formats">
        <span class="format-badge">MP3</span>
        <span class="format-badge">WAV</span>
        <span class="format-badge">M4A</span>
        <span class="format-badge">OGG</span>
        <span class="format-badge">FLAC</span>
      </div>
    </div>
    <input type="file" id="file-input" accept=".mp3,.wav,.m4a,.ogg,.flac,audio/*">
    <div class="file-preview" id="file-preview">
      <div class="file-icon">‚ô™</div>
      <div class="file-info">
        <div class="file-name" id="file-name">filename.mp3</div>
        <div class="file-size" id="file-size">0 KB</div>
      </div>
      <button class="remove-file" id="remove-file" title="Remove">‚úï</button>
    </div>
  </section>

  <!-- Sheet Music Format - Output -->
  <section style="margin-bottom:24px">
    <div class="section-label">02 ‚Äî Configure Transcription</div>
    <div class="options-grid">
      <div class="option-card">
        <div class="option-title">Output Format</div>
        <div class="radio-group" id="output-format">
          <label class="radio-option selected" data-val="musicxml">
            <span class="radio-dot"></span>
            <div><div class="radio-label">MusicXML</div><div class="radio-sub">Opens in MuseScore, Finale, Sibelius</div></div>
          </label>
          <label class="radio-option" data-val="midi">
            <span class="radio-dot"></span>
            <div><div class="radio-label">MIDI</div><div class="radio-sub">For DAWs and digital playback</div></div>
          </label>
          <label class="radio-option" data-val="pdf">
            <span class="radio-dot"></span>
            <div><div class="radio-label">PDF</div><div class="radio-sub">Print-ready (requires MuseScore)</div></div>
          </label>
        </div>
      </div>

      <div class="option-card">
        <div class="option-title">Key Signature</div>
        <select class="styled-select" id="key-sig" style="margin-bottom:16px">
          <option value="auto">Auto-detect</option>
          <option value="C">C Major / A Minor</option>
          <option value="G">G Major / E Minor</option>
          <option value="D">D Major / B Minor</option>
          <option value="A">A Major / F# Minor</option>
          <option value="F">F Major / D Minor</option>
          <option value="Bb">B‚ô≠ Major / G Minor</option>
          <option value="Eb">E‚ô≠ Major / C Minor</option>
        </select>
        <div class="option-title">Time Signature</div>
        <select class="styled-select" id="time-sig">
          <option value="auto">Auto-detect</option>
          <option value="4/4">4/4 ‚Äî Common Time</option>
          <option value="3/4">3/4 ‚Äî Waltz</option>
          <option value="6/8">6/8 ‚Äî Compound</option>
          <option value="2/4">2/4 ‚Äî March</option>
          <option value="5/4">5/4 ‚Äî Odd Meter</option>
        </select>
      </div>
    </div>

    <span class="advanced-toggle" id="advanced-toggle">‚öô Advanced Basic Pitch Settings</span>
    <div class="advanced-panel" id="advanced-panel">
      <div>
        <div class="slider-label">
          <span>Onset Threshold</span>
          <span id="onset-val">0.50</span>
        </div>
        <input type="range" id="onset-thresh" min="0.1" max="0.9" step="0.05" value="0.5">
        <div class="radio-sub" style="margin-top:6px">Higher = fewer, more confident note onsets</div>
      </div>
      <div>
        <div class="slider-label">
          <span>Frame Threshold</span>
          <span id="frame-val">0.30</span>
        </div>
        <input type="range" id="frame-thresh" min="0.1" max="0.9" step="0.05" value="0.3">
        <div class="radio-sub" style="margin-top:6px">Higher = shorter notes, less sustain captured</div>
      </div>
    </div>
  </section>

  <div class="transcribe-wrap">
    <button class="btn-transcribe" id="btn-transcribe" disabled>
      ùÑû &nbsp; Transcribe to Sheet Music
    </button>
  </div>

  <div class="error-box" id="error-box">
    <div class="error-title">‚ö† Transcription Error</div>
    <div class="error-msg" id="error-msg"></div>
  </div>

  <section class="processing-section" id="processing-section">
    <div class="section-label">Processing</div>
    <div class="waveform-display" id="waveform"></div>
    <div class="pipeline">
      <div class="pipeline-step" id="step-1"><div class="step-num">01</div><span class="step-icon">üìÇ</span><div class="step-label">Upload</div></div>
      <div class="pipeline-step" id="step-2"><div class="step-num">02</div><span class="step-icon">üéµ</span><div class="step-label">Basic Pitch</div></div>
      <div class="pipeline-step" id="step-3"><div class="step-num">03</div><span class="step-icon">üéπ</span><div class="step-label">MIDI</div></div>
      <div class="pipeline-step" id="step-4"><div class="step-num">04</div><span class="step-icon">üìÑ</span><div class="step-label">Sheet Music</div></div>
    </div>
    <div class="progress-bar-wrap"><div class="progress-bar" id="progress-bar"></div></div>
    <div class="processing-message" id="processing-msg">Uploading audio file‚Ä¶</div>
  </section>

  <!-- Output Section to view genereted Sheet Music -->
  <section class="results-section" id="results-section">
    <div class="section-label">04 ‚Äî Your Sheet Music</div>
    <div class="stats-row" id="stats-row"></div>
    <div class="notes-display">
      <div class="notes-title">Detected Notes</div>
      <div class="notes-scroll" id="notes-display"></div>
    </div>
    <div class="sheet-music-display">
      <div class="sheet-header">
        <div class="sheet-title" id="result-title">Transcription</div>
        <div class="sheet-subtitle">Generated by NoteScribe ¬∑ Basic Pitch (Spotify) ‚Üí music21</div>
        <div class="sheet-meta">
          <span id="result-key">Key: C Major</span>
          <span id="result-time">Time: 4/4</span>
          <span id="result-tempo">‚ô© = 120 BPM</span>
        </div>
      </div>
      <div id="staff-svg-wrap"></div>
    </div>
    <div class="result-actions" id="result-actions"></div>
  </section>
</div>

<footer class="container">
  <div class="footer-brand">ùÑû NoteScribe</div>
  <div>Powered by Basic Pitch (Spotify) + music21</div>
  <div>Pipeline: Audio ‚Üí Pitch ‚Üí MIDI ‚Üí MusicXML</div>
</footer>

<div class="toast" id="toast"></div>

<script>
const API_BASE = 'http://localhost:5000'; 
let selectedFile = null;
let currentJobId = null;
let outputFormat = 'musicxml';

// Code to upload an audio file
const uploadZone = document.getElementById('upload-zone');
const fileInput  = document.getElementById('file-input');
uploadZone.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', e => handleFile(e.target.files[0]));
uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('drag-over'); });
uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('drag-over'));
uploadZone.addEventListener('drop', e => { e.preventDefault(); uploadZone.classList.remove('drag-over'); if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]); });

function handleFile(file) {
  if (!file) return;
  selectedFile = file;
  document.getElementById('file-name').textContent = file.name;
  document.getElementById('file-size').textContent = formatBytes(file.size);
  document.getElementById('file-preview').classList.add('show');
  document.getElementById('btn-transcribe').disabled = false;
  showToast('File loaded: ' + file.name);
}

document.getElementById('remove-file').addEventListener('click', () => {
  selectedFile = null; fileInput.value = '';
  document.getElementById('file-preview').classList.remove('show');
  document.getElementById('btn-transcribe').disabled = true;
});

function formatBytes(b) {
  if (b < 1024) return b + ' B';
  if (b < 1048576) return (b/1024).toFixed(1) + ' KB';
  return (b/1048576).toFixed(2) + ' MB';
}

// ‚îÄ‚îÄ Radio options ‚îÄ‚îÄ
document.querySelectorAll('#output-format .radio-option').forEach(opt => {
  opt.addEventListener('click', () => {
    document.querySelectorAll('#output-format .radio-option').forEach(o => o.classList.remove('selected'));
    opt.classList.add('selected');
    outputFormat = opt.dataset.val;
  });
});

// ‚îÄ‚îÄ Waveform ‚îÄ‚îÄ
function buildWaveform() {
  const wf = document.getElementById('waveform');
  wf.innerHTML = '';
  for (let i = 0; i < 80; i++) {
    const bar = document.createElement('div');
    bar.className = 'wave-bar';
    bar.style.height = (10 + Math.random() * 80) + '%';
    bar.style.animationDelay = (Math.random() * 1.5) + 's';
    bar.style.animationDuration = (0.8 + Math.random() * 1.2) + 's';
    wf.appendChild(bar);
  }
}

// ‚îÄ‚îÄ Steps ‚îÄ‚îÄ
function setStep(idx) {
  const steps = ['step-1','step-2','step-3','step-4'];
  const msgs = [
    'Uploading audio to server‚Ä¶',
    'Running Basic Pitch pitch detection model‚Ä¶',
    'Quantizing notes into MIDI‚Ä¶',
    'Engraving sheet music with music21‚Ä¶'
  ];
  const progresses = [20, 50, 75, 95];
  steps.forEach((id, i) => {
    const el = document.getElementById(id);
    el.classList.remove('active','done');
    if (i < idx) el.classList.add('done');
    else if (i === idx) el.classList.add('active');
  });
  document.getElementById('progress-bar').style.width = progresses[idx] + '%';
  document.getElementById('processing-msg').textContent = msgs[idx];
}

// ‚îÄ‚îÄ Main transcription call ‚îÄ‚îÄ
document.getElementById('btn-transcribe').addEventListener('click', runTranscription);

async function runTranscription() {
  if (!selectedFile) return;

  const errorBox = document.getElementById('error-box');
  errorBox.classList.remove('show');
  document.getElementById('btn-transcribe').disabled = true;
  document.getElementById('processing-section').classList.add('show');
  document.getElementById('results-section').classList.remove('show');
  buildWaveform();
  setStep(0);

  const formData = new FormData();
  formData.append('file', selectedFile);
  formData.append('key_sig', document.getElementById('key-sig').value);
  formData.append('time_sig', document.getElementById('time-sig').value);
  formData.append('output_format', outputFormat);
  formData.append('onset_threshold', document.getElementById('onset-thresh').value);
  formData.append('frame_threshold', document.getElementById('frame-thresh').value);

  try {
    await delay(600);
    setStep(1);

    const response = await fetch(`${API_BASE}/transcribe`, {
      method: 'POST',
      body: formData,
    });

    setStep(2);
    await delay(400);
    setStep(3);

    const data = await response.json();

    if (!response.ok) {
      throw new Error(data.error || 'Server returned an error');
    }

    await delay(600);
    document.getElementById('progress-bar').style.width = '100%';

    currentJobId = data.job_id;
    await showResults(data);

  } catch (err) {
    console.error(err);
    document.getElementById('error-msg').textContent = err.message + '\n\nMake sure the Python backend is running: python app.py';
    errorBox.classList.add('show');
    document.getElementById('processing-section').classList.remove('show');
    showToast('‚ö† Transcription failed');
  } finally {
    document.getElementById('btn-transcribe').disabled = false;
  }
}

async function showResults(data) {
  const meta = data.metadata;

  // Stats & Notes 
  document.getElementById('stats-row').innerHTML = [
    { val: meta.note_count, label: 'Notes Detected' },
    { val: meta.measure_count, label: 'Measures' },
    { val: meta.tempo_bpm + ' BPM', label: 'Tempo' },
    { val: meta.key, label: 'Key' },
  ].map(s => `<div class="stat-card"><div class="stat-val">${s.val}</div><div class="stat-label">${s.label}</div></div>`).join('');

  document.getElementById('notes-display').innerHTML = (meta.notes_sample || [])
    .map((n, i) => `<span class="note-chip" style="animation-delay:${i * 0.03}s">${n}</span>`).join('');

  // Create Header
  const fname = selectedFile.name.replace(/\.[^.]+$/, '');
  document.getElementById('result-title').textContent = fname;
  document.getElementById('result-key').textContent = 'Key: ' + meta.key;
  document.getElementById('result-time').textContent = 'Time: ' + meta.time_signature;
  document.getElementById('result-tempo').textContent = `‚ô© = ${meta.tempo_bpm} BPM`;

  // Render staff SVG
  renderStaff(meta.notes_sample || [], meta.time_signature);

  // Download buttons
  const actions = document.getElementById('result-actions');
  actions.innerHTML = '';
  for (const [fmt, url] of Object.entries(data.download_urls)) {
    const a = document.createElement('a');
    a.className = 'btn-action' + (fmt === 'musicxml' ? ' primary' : '');
    a.href = `${API_BASE}${url}`;
    a.download = '';
    a.innerHTML = `‚¨á Download ${fmt.toUpperCase()}`;
    actions.appendChild(a);
  }
  const newBtn = document.createElement('button');
  newBtn.className = 'btn-action';
  newBtn.innerHTML = '‚Ü∫ Transcribe Another';
  newBtn.addEventListener('click', resetUI);
  actions.appendChild(newBtn);

  document.getElementById('results-section').classList.add('show');
  document.getElementById('results-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
  showToast('Transcription complete ‚úì');
}

function resetUI() {
  selectedFile = null;
  fileInput.value = '';
  document.getElementById('file-preview').classList.remove('show');
  document.getElementById('btn-transcribe').disabled = true;
  document.getElementById('processing-section').classList.remove('show');
  document.getElementById('results-section').classList.remove('show');
  document.getElementById('error-box').classList.remove('show');
  ['step-1','step-2','step-3','step-4'].forEach(id => document.getElementById(id).classList.remove('active','done'));
  document.getElementById('progress-bar').style.width = '0';
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// ‚îÄ‚îÄ SVG staff renderer ‚îÄ‚îÄ
function renderStaff(notes, timeSig) {
  const NOTE_Y = {
    'C3':74,'D3':70,'E3':66,'F3':62,'G3':58,'A3':54,'B3':50,
    'C4':46,'D4':42,'E4':38,'F4':34,'G4':30,'A4':26,'B4':22,
    'C5':18,'D5':14,'E5':10,'F5':6,'G5':2,
    'C#3':74,'D#3':70,'F#3':62,'G#3':58,'A#3':54,
    'C#4':46,'D#4':42,'F#4':34,'G#4':30,'A#4':26,
    'C#5':18,'D#5':14,'F#5':6,
  };

  const beatsPerMeasure = timeSig === '3/4' ? 3 : timeSig === '6/8' ? 6 : timeSig === '2/4' ? 2 : 4;
  const measPerRow = 4;
  const rows = Math.max(1, Math.ceil(Math.ceil(notes.length / beatsPerMeasure) / measPerRow));
  const W = 900, rowH = 110, marginL = 68, noteW = 18;
  const staffTop = 20, staffSpacing = 10, lineCount = 5;
  const H = rows * rowH + 40;
  const measWidth = (W - marginL - 20) / measPerRow;

  let svg = `<svg width="${W}" height="${H}" viewBox="0 0 ${W} ${H}" style="max-width:100%">`;
  svg += `<rect width="${W}" height="${H}" fill="white"/>`;

  for (let row = 0; row < rows; row++) {
    const ry = 30 + row * rowH;
    for (let l = 0; l < lineCount; l++) {
      const y = ry + staffTop + l * staffSpacing;
      svg += `<line x1="${marginL - 12}" y1="${y}" x2="${W - 10}" y2="${y}" stroke="#333" stroke-width="1.2"/>`;
    }
    svg += `<text x="${marginL - 56}" y="${ry + staffTop + 36}" font-size="52" fill="#111" style="font-family:serif">ùÑû</text>`;

    // Time Signature
    const [beats] = timeSig === 'auto' ? [4,4] : (timeSig || '4/4').split('/').map(Number);
    const beatVal = timeSig === '6/8' ? 8 : 4;
    svg += `<text x="${marginL + 2}" y="${ry + staffTop + 16}" font-size="15" font-weight="bold" fill="#222">${beats}</text>`;
    svg += `<text x="${marginL + 2}" y="${ry + staffTop + 32}" font-size="15" font-weight="bold" fill="#222">${beatVal}</text>`;

    for (let m = 0; m < measPerRow; m++) {
      const measIdx = row * measPerRow + m;
      const totalMeasures = Math.ceil(notes.length / beatsPerMeasure);
      if (measIdx >= totalMeasures) break;

      const mx = marginL + 28 + m * measWidth;
      svg += `<line x1="${mx}" y1="${ry + staffTop}" x2="${mx}" y2="${ry + staffTop + (lineCount-1)*staffSpacing}" stroke="#444" stroke-width="1.5"/>`;

      for (let n = 0; n < beatsPerMeasure; n++) {
        const ni = measIdx * beatsPerMeasure + n;
        if (ni >= notes.length) break;
        const note = notes[ni];
        const nx = mx + 14 + n * (measWidth / beatsPerMeasure);
        const baseNote = note.replace(/b/, '').replace('‚ô≠','');
        let ny = ry + staffTop + (NOTE_Y[note] !== undefined ? NOTE_Y[note] / 10 * staffSpacing : 2 * staffSpacing);

        if (note.startsWith('C4') || note === 'C4') {
          const ledgerY = ry + staffTop + lineCount * staffSpacing + staffSpacing / 2;
          svg += `<line x1="${nx - 5}" y1="${ledgerY}" x2="${nx + 13}" y2="${ledgerY}" stroke="#555" stroke-width="1"/>`;
          ny = ledgerY;
        }

        const isSharp = note.includes('#');
        if (isSharp) svg += `<text x="${nx - 9}" y="${ny + 4}" font-size="11" fill="#333">‚ôØ</text>`;
        svg += `<ellipse cx="${nx + 5}" cy="${ny}" rx="6" ry="4.5" fill="#111" transform="rotate(-18,${nx+5},${ny})"/>`;
        const stemDir = ny > (ry + staffTop + 2.5 * staffSpacing) ? -1 : 1;
        const stemX = stemDir > 0 ? nx - 1 : nx + 11;
        svg += `<line x1="${stemX}" y1="${ny}" x2="${stemX}" y2="${ny + stemDir * 28}" stroke="#111" stroke-width="1.5"/>`;
      }
    }

    const lastM = Math.min(measPerRow, Math.ceil(notes.length / beatsPerMeasure) - row * measPerRow);
    const fx = marginL + 28 + lastM * measWidth;
    svg += `<line x1="${fx - 4}" y1="${ry + staffTop}" x2="${fx - 4}" y2="${ry + staffTop + (lineCount-1)*staffSpacing}" stroke="#444" stroke-width="1.2"/>`;
    svg += `<line x1="${fx}" y1="${ry + staffTop}" x2="${fx}" y2="${ry + staffTop + (lineCount-1)*staffSpacing}" stroke="#444" stroke-width="2.5"/>`;
  }

  svg += '</svg>';
  document.getElementById('staff-svg-wrap').innerHTML = svg;
}

function delay(ms) { return new Promise(r => setTimeout(r, ms)); }

let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 3000);
}
</script>
</body>
</html>